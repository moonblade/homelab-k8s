# CLUSTER: SIRIUS

## OVERVIEW

K3s cluster overlay. Apps, infra, and bootstrap manifests for the "sirius" homelab cluster.

## STRUCTURE

```
sirius/
├── apps/                 # 29 application deployments
├── bootstrap/            # Flux entry point (gotk watches here)
│   ├── apps/             # App Kustomization stubs (.yaml.disabled = off)
│   ├── flux-system/      # gotk-components, gotk-sync, root kustomization
│   └── infra/            # Infra Kustomization stubs
└── infra/                # Infra overlays (cert-manager, external-dns, etc.)
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Enable app | `bootstrap/apps/<app>.yaml` | Remove `.disabled` suffix |
| Disable app | `bootstrap/apps/<app>.yaml.disabled` | Add `.disabled` suffix |
| App manifests | `apps/<app>/` | deployment, service, ingress, kustomization |
| Infra overlay | `infra/<component>/kustomization.yaml` | References `base/infra/` |
| Flux sync config | `bootstrap/flux-system/gotk-sync.yaml` | GitRepository + Kustomization |
| DNS endpoints | `infra/external-dns/dnsendpoints.yaml` | Static DNS entries |

## CONVENTIONS

- **App namespace**: Set in `apps/<app>/kustomization.yaml` via `namespace:` field
- **Sealed secrets**: `secret-sealed.yaml` in app directory
- **Image updates**: `imageupdate.yaml` with ImageRepository/ImagePolicy/ImageUpdateAutomation
- **Relative overlay paths**: `../../../../base/infra/<component>` to reference bases
- **Health checks**: Bootstrap Kustomizations include `healthChecks` for deployments

## APP TEMPLATE

New app requires:
1. `bootstrap/apps/<app>.yaml` - Namespace + Flux Kustomization pointing to `clusters/sirius/apps/<app>`
2. `apps/<app>/kustomization.yaml` - Lists resources, sets namespace
3. `apps/<app>/deployment.yaml` - Deployment manifest
4. `apps/<app>/service.yaml` - Service manifest
5. `apps/<app>/ingress.yaml` - Ingress with TLS and cert-manager annotation
6. (Optional) `apps/<app>/secret-sealed.yaml` - Sealed credentials
7. (Optional) `apps/<app>/imageupdate.yaml` - Flux image automation

## ANTI-PATTERNS

- **DO NOT edit `bootstrap/flux-system/gotk-*.yaml`** - generated by flux
- **DO NOT skip namespace** in app kustomization - causes resource conflicts
- **DO NOT use HelmRelease for simple apps** - pattern here is direct manifests for apps

## NOTES

- Bootstrap path in gotk-sync: `./clusters/sirius/bootstrap`
- Apps push image updates to `main` branch via fluxcdbot
- Some infra disabled: cilium, longhorn, flannel (see `.disabled` files)
