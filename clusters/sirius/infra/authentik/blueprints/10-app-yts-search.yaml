# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
version: 1
metadata:
  name: app-yts-search
  labels:
    blueprints.goauthentik.io/description: "YTS Search proxy application"
entries:
  - model: authentik_providers_proxy.proxyprovider
    id: yts-search-provider
    state: present
    identifiers:
      name: Provider for YTS Search
    attrs:
      name: Provider for YTS Search
      mode: proxy
      external_host: https://ytssearch.moonblade.work
      internal_host: http://yts-downloader.yts-downloader.svc.cluster.local
      intercept_header_auth: true
      access_token_validity: hours=24
      refresh_token_validity: days=30
      authentication_flow: !Find [authentik_flows.flow, [slug, google-login]]
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

  - model: authentik_core.application
    id: yts-search-app
    state: present
    identifiers:
      slug: yts-search
    attrs:
      name: YTS Search
      slug: yts-search
      provider: !KeyOf yts-search-provider
      policy_engine_mode: any
      meta_launch_url: https://ytssearch.moonblade.work

  # Policy binding to allow users with admin role
  - model: authentik_policies.policybinding
    id: yts-search-policy-binding
    state: present
    identifiers:
      order: 0
      target: !KeyOf yts-search-app
    attrs:
      policy: !Find [authentik_policies_expression.expressionpolicy, [name, "Has role \"admin\""]]
      target: !KeyOf yts-search-app
      order: 0
      enabled: true
      timeout: 30

  - model: authentik_outposts.outpost
    id: yts-search-outpost
    state: present
    identifiers:
      name: YTS Search
    attrs:
      name: YTS Search
      type: proxy
      service_connection: !Find [authentik_outposts.kubernetesserviceconnection, [name, Local Kubernetes Cluster]]
      providers:
        - !KeyOf yts-search-provider
      config:
        authentik_host: https://login.moonblade.work/
        kubernetes_namespace: authentik
        kubernetes_replicas: 1
        kubernetes_service_type: ClusterIP
        kubernetes_disabled_components:
          - Ingress
        object_naming_template: ak-outpost-%(name)s
        log_level: info
