# PROJECT KNOWLEDGE BASE

**Generated:** 2026-02-21
**Commit:** 450ddbb
**Branch:** main

## OVERVIEW

Homelab Kubernetes manifests for K3s cluster "sirius" on NixOS. Flux GitOps with kustomize overlays, sealed secrets, and image automation.

## STRUCTURE

```
homelab-k8s/
├── base/infra/           # Reusable infra bases (Helm/kustomize)
├── clusters/sirius/      # Cluster-specific overlays
│   ├── apps/             # Application manifests (29 apps)
│   ├── bootstrap/        # Flux entry point (gotk-sync watches this)
│   └── infra/            # Infra overlays + cluster-specific config
├── secrets/              # git-crypt encrypted, kubeseal keys
└── Makefile              # Bootstrap commands
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Bootstrap cluster | `make kuztomize-flux-sirius` | Applies `clusters/sirius/bootstrap/flux-system` |
| Add new app | `clusters/sirius/apps/<app>/` | See existing app for template |
| Add new infra | `base/infra/<component>/` + overlay in `clusters/sirius/infra/` | Base + overlay pattern |
| Enable/disable app | `clusters/sirius/bootstrap/apps/*.yaml` | Rename to `.disabled` to disable |
| Seal a secret | `cat secrets/secret.yaml \| kubeseal -o yaml` | Outputs SealedSecret |
| Create kubeseal key | `make create-sealed-secret-key` | Uses keys in `secrets/` |

## CONVENTIONS

- **Flux GitOps**: All deployments via Flux Kustomization/HelmRelease
- **No ArgoCD**: Flux only (weave-gitops installed for UI)
- **Namespace per app**: Each kustomization sets `namespace:` field
- **Base + Overlay**: `base/infra/` = reusable, `clusters/sirius/infra/` = overlay with relative `../../../../base/...` paths
- **SealedSecrets**: Raw secrets in `secrets/raw_secrets/`, sealed versions in app dirs as `secret-sealed.yaml`
- **Image automation**: Apps use `imageupdate.yaml` with Flux ImageRepository/Policy/UpdateAutomation
- **Image tag pattern**: `^ts_(?P<ts>[0-9]+)$` - timestamp-based tags

## ANTI-PATTERNS (THIS PROJECT)

- **DO NOT edit** `gotk-components.yaml` / `gotk-sync.yaml` - generated by Flux, will be overwritten
- **DO NOT commit raw secrets** to `clusters/` - use SealedSecrets (kubeseal)
- **DO NOT use `image:latest`** - pin with semver or timestamp tags
- **NEVER mix ingress controllers** without explicit IngressClass - both nginx-gateway-fabric and ingress-nginx exist

## UNIQUE STYLES

- **Disabled files**: `.yaml.disabled` suffix = not applied by Flux
- **Bootstrap entry**: Flux watches `clusters/sirius/bootstrap/` (per `gotk-sync.yaml`)
- **Per-app structure**: `deployment.yaml`, `service.yaml`, `ingress.yaml`, `kustomization.yaml`, optional `secret-sealed.yaml`, `imageupdate.yaml`
- **HelmRelease for infra**: Most infra uses Flux HelmRelease referencing remote charts
- **Direct manifests for apps**: Most apps use plain Deployment/Service/Ingress

## COMMANDS

```bash
# Initial cluster setup
make kuztomize-flux-sirius
make create-git-secret
make create-sealed-secret-key
sleep 5
make kuztomize-flux-sirius

# Seal a secret
cat secrets/secret.yaml | kubeseal -o yaml > path/to/secret-sealed.yaml

# Get dashboard token
make dashboard-token

# Full Flux bootstrap (first time only)
make bootstrap-git-sirius
```

## NOTES

- **Storage**: local-path-provisioner active, longhorn disabled (had issues)
- **Cert challenges**: IPv6 was disabled in NixOS due to ACME challenge failures
- **SSO**: Authentik for single sign-on, still being integrated
- **External DNS**: Cloudflare via external-dns, filters by ingress annotations
- **Domain**: `*.sirius.moonblade.work`
